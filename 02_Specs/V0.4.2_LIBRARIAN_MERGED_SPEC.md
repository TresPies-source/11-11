# Dojo Genesis v0.4.2 - Librarian Merged Tech Spec

**Author:** Manus AI (Dojo)
**Version:** 1.0
**Date:** January 2026
**Status:** Ready for Development

---

## 1. Overview

This document provides the comprehensive technical specifications for the **Librarian Refactor (v0.4.2)**. The goal is to merge the advanced functionality of the existing Librarian implementation with the new, polished Dojo Genesis design system established in Wave 1.

This is primarily a **visual refactoring and bug-fixing task**. The core logic, hooks, and advanced features of the existing implementation are more advanced than the original v0.4.1 spec and **must be preserved**.

### 1.1. Guiding Principles

1.  **No Regressions:** All existing features (semantic search, suggestions, critiques, status lifecycle, etc.) must remain fully functional.
2.  **Design System First:** All UI components must be refactored to use the established Dojo Genesis design system (colors, typography, spacing, and base components from Wave 1).
3.  **Component Consolidation:** Replace custom, one-off components with the standardized `Card`, `Button`, and `StatusDot` components from `/components/ui/`.
4.  **Improve, Don't Rebuild:** The focus is on improving the presentation layer and fixing bugs, not re-architecting the data or logic layers.

---

## 2. Global Refactoring Tasks

These changes apply to **all** components within the `/components/librarian/` directory.

### 2.1. Color Palette

-   **Action:** Remove all hardcoded colors and gradient classes (e.g., `from-green-50`, `text-pink-600`).
-   **Replacement:** Use the Tailwind CSS variables defined in `tailwind.config.ts` (e.g., `bg-bg-primary`, `text-text-accent`, `border-border-tertiary`).

### 2.2. Base Components

-   **Action:** Replace all custom `div`-based cards and `button` elements with the standardized Wave 1 components.
-   **Card:** Use `<Card>` and `<Card glow={true}>` for all card-like containers.
-   **Button:** Use `<Button variant="primary|secondary" size="sm|md|lg">` for all buttons and actions.
-   **StatusDot:** Use `<StatusDot status="...">` for all status indicators.

### 2.3. Typography and Spacing

-   **Action:** Remove all custom font size and spacing classes.
-   **Replacement:** Use the `font-sans` and `font-mono` variables and the spacing scale (`p-4`, `gap-6`, etc.) defined in the Tailwind config.

### 2.4. Animations

-   **Action:** Standardize all Framer Motion animations.
-   **Replacement:** Use the standard `whileHover={{ scale: 1.05 }}` and `whileTap={{ scale: 0.98 }}`. Ensure transition durations match the design system.

---

## 3. Component-Specific Refactoring Guide

### 3.1. `LibrarianView.tsx`

-   **Keep:** All existing hooks (`useLibrarian`, `useSemanticSearch`, `useSuggestions`), state management, and event handlers (`handleSaveToGreenhouse`, `handleSearch`, etc.).
-   **Refactor:**
    -   Replace the main header section with a simple `<h1>` for "The Librarian's Home" and a `<h2>` for the subtitle, styled according to the mockups.
    -   Remove the two large navigation links ("My Greenhouse", "The Global Commons"). This navigation is now handled by the main app sidebar.
    -   The `Semantic Search` section should be wrapped in a `<Card>` component.
    -   Update all icons to use `lucide-react` and apply colors from the design system (e.g., `text-supervisor`, `text-librarian`).
-   **Fix:** Add `aria-label` attributes to all major sections (`<main>`, `<section>`).

### 3.2. `SearchBar.tsx`

-   **Keep:** All props (`value`, `onChange`, `onSearch`, `loading`, etc.) and internal logic.
-   **Refactor:**
    -   Restyle the main input field to match the Librarian mockup: large, clean, and using `bg-bg-secondary` and `border-border-tertiary`.
    -   Ensure the search icon color matches the design system.
    -   Update the loading spinner to a more subtle animation.

### 3.3. `SearchResults.tsx` & `SearchResultCard.tsx`

-   **Keep:** Logic for displaying loading states, error states, and the list of results.
-   **Refactor `SearchResults.tsx`:**
    -   Change the layout to a responsive grid (`grid-cols-1 md:grid-cols-2 lg:grid-cols-3`).
-   **Refactor `SearchResultCard.tsx`:**
    -   This is a critical refactoring task.
    -   Replace the root `div` with `<Card glow={true}>`.
    -   Display the `similarity` score as a badge in the top-right corner, styled with `bg-supervisor` and `text-white`.
    -   Create and use a new standardized `Tag.tsx` component for displaying tags.
    -   Replace all action buttons with the Wave 1 `<Button size="sm">` component.

### 3.4. `SeedlingSection.tsx` & `SeedlingCard.tsx`

-   **Keep:** All data fetching and status transition logic.
-   **Refactor:**
    -   Rename "Seedling" to "Active Prompts" in all UI text.
    -   Refactor `SeedlingCard.tsx` to use the base `<Card>` component.
    -   Replace the critique score display with a simple badge.
    -   Replace all action buttons (`Save to Greenhouse`, `Archive`) with the standardized `<Button>` component.

### 3.5. `GreenhouseSection.tsx` & `GreenhouseCard.tsx`

-   **Keep:** All data fetching and status transition logic.
-   **Refactor:**
    -   Rename "Greenhouse" to "Saved Prompts" in all UI text.
    -   Refactor `GreenhouseCard.tsx` to use the base `<Card>` component.
    -   Replace all action buttons (`Edit`, `Publish`, `Archive`) with the standardized `<Button>` component.

### 3.6. `SuggestionsPanel.tsx`

-   **Keep:** All suggestion fetching and dismissing logic from the `useSuggestions` hook.
-   **Refactor:**
    -   Wrap the entire panel in a `<Card>`.
    -   Restyle the suggestion items to be cleaner and more compact, using design system typography and spacing.

---

## 4. New Components

### 4.1. `Tag.tsx`

-   **File:** `/components/ui/Tag.tsx`
-   **Props:** `label: string`
-   **Styling:** A simple, reusable tag component with `bg-bg-tertiary`, `rounded-full`, `px-3`, `py-1`, and `text-xs`.

---

## 5. Bug Fixes & Accessibility

1.  **Component Splitting:** Break down the largest components (`LibrarianView`, `SeedlingCard`, `GreenhouseCard`) into smaller, more manageable sub-components where appropriate.
2.  **Standardize Naming:** Ensure UI text is consistent. Use "Active Prompts" instead of "Seedlings" and "Saved Prompts" instead of "Greenhouse". The code can retain the old names for now to minimize breaking changes, but UI text must be updated.
3.  **ARIA Labels:** Add descriptive `aria-label` attributes to all interactive elements, including buttons, links, and input fields, to ensure full accessibility.

---

## 6. Acceptance Criteria

-   [ ] **No Functional Regressions:** All existing advanced features of the Librarian are preserved and fully functional.
-   [ ] **Visual Consistency:** The entire Librarian UI (`/librarian`, `/greenhouse`, `/commons`) is visually consistent with the Dojo Genesis design system.
-   [ ] **Component Usage:** All custom cards, buttons, and status dots have been replaced with the standardized components from `/components/ui/`.
-   [ ] **Bug Fixes:** The identified bugs related to naming and accessibility have been resolved.
-   [ ] **Code Quality:** Large components have been reasonably broken down for better maintainability.
-   [ ] The application is stable, and all existing tests pass.







# Librarian Feature Analysis & Inventory

**Author:** Manus AI (Dojo)
**Date:** January 2026
**Purpose:** Document existing Librarian implementation to create merged tech spec

---

## 1. Current Implementation Overview

The existing Librarian is a **highly advanced, feature-rich implementation** with sophisticated functionality that goes far beyond the initial v0.4.1 spec. It includes:

- **Multi-page architecture** (`/librarian`, `/librarian/greenhouse`, `/librarian/commons`)
- **AI-powered semantic search** with vector embeddings
- **Proactive suggestions system**
- **Automated prompt critiques** with scoring
- **Status lifecycle management** (draft → active → saved → archived)
- **Public/private prompt sharing**
- **Real-time optimistic UI updates**
- **Error boundaries and loading states**
- **Recent searches tracking**
- **Bulk actions**

---

## 2. Component Inventory

### 2.1. Main Pages

| Component | Path | Purpose |
|-----------|------|---------|
| `LibrarianView` | `components/librarian/LibrarianView.tsx` | Main landing page with Seedlings, Greenhouse nav, and semantic search |
| `GreenhouseView` | `components/librarian/GreenhouseView.tsx` | Personal library of saved prompts |
| `CommonsView` | `components/librarian/CommonsView.tsx` | Public community prompts (Global Commons) |

### 2.2. Card Components

| Component | Lines | Purpose |
|-----------|-------|---------|
| `SeedlingCard` | ~350 | Active prompts with critique scores, status transitions |
| `GreenhouseCard` | ~400 | Saved prompts with edit/archive/publish actions |
| `CommonsPromptCard` | ~200 | Public prompts with copy-to-library action |
| `SearchResultCard` | ~200 | Semantic search results with similarity scores |
| `ArchiveCard` | ~250 | Archived prompts with restore functionality |

### 2.3. Feature Components

| Component | Purpose |
|-----------|---------|
| `SearchBar` | Semantic search input with loading/result count |
| `SearchResults` | Grid display of search results |
| `SuggestionsPanel` | AI-powered proactive suggestions |
| `RecentSearches` | Recent search history |
| `CritiqueDetails` | Detailed prompt critique breakdown |
| `CritiqueScore` | Visual score display |
| `BulkActionBar` | Multi-select bulk operations |
| `StatusFilter` | Filter prompts by status |
| `PublicToggle` | Toggle prompt visibility |
| `ConfirmationDialog` | Reusable confirmation modal |

---

## 3. Advanced Features

### 3.1. Semantic Search

**Implementation:**
- Uses `useSemanticSearch` hook
- Connects to Supabase Vector (pgvector)
- Generates embeddings via OpenAI API
- Returns similarity scores (0-100%)
- Tracks search duration and result count

**UI Features:**
- Real-time search as you type
- Loading states
- Result count display
- Search duration display
- Clear search functionality

### 3.2. Proactive Suggestions

**Implementation:**
- Uses `useSuggestions` hook
- Triggers on page load
- Fetches 6 suggestions at a time
- Dismissible suggestions
- Refresh functionality

**UI Features:**
- Card-based suggestion display
- Dismiss individual suggestions
- Refresh all suggestions
- Loading skeleton states

### 3.3. Prompt Critiques

**Implementation:**
- AI-powered analysis of prompt quality
- Scores on 4 dimensions:
  - Conciseness
  - Specificity
  - Context
  - Task Decomposition
- Overall score (0-100)

**UI Features:**
- Visual score badges
- Expandable critique details
- Color-coded scores (red/yellow/green)

### 3.4. Status Lifecycle

**States:**
- `draft` - Initial state
- `active` - Working prompts (Seedlings)
- `saved` - Mature prompts (Greenhouse)
- `archived` - Retired prompts

**Transitions:**
- Optimistic UI updates
- Google Drive sync
- Toast notifications
- Automatic refresh

### 3.5. Public/Private Sharing

**Features:**
- Toggle prompt visibility
- Publish confirmation dialog
- Copy public prompts to personal library
- Fork count tracking

---

## 4. Hooks & Data Layer

### 4.1. Custom Hooks

| Hook | Purpose | Features |
|------|---------|----------|
| `useLibrarian` | Fetch prompts by status | Loading, error, retry, optimistic updates |
| `useSemanticSearch` | Vector search | Auto-search, debouncing, duration tracking |
| `useSuggestions` | AI suggestions | Auto-load, dismiss, refresh |
| `usePromptStatus` | Status transitions | Drive sync, optimistic updates |
| `useToast` | Notifications | Success/error messages |

### 4.2. API Routes

| Route | Purpose |
|-------|---------|
| `/api/librarian/search` | Semantic search endpoint |
| `/api/librarian/suggestions` | Proactive suggestions |
| `/api/librarian/critique` | Prompt critique |
| `/api/agents/librarian` | Librarian agent handler |

---

## 5. Known Issues & Bugs

### 5.1. Style Inconsistencies

- **Problem:** Uses old color scheme (pink/green/blue gradients) instead of Dojo Genesis palette (teal/amber)
- **Impact:** Visual disconnect from rest of application
- **Files Affected:** All Librarian components

### 5.2. Component Naming

- **Problem:** Inconsistent naming ("Seedling" vs "Active", "Greenhouse" vs "Saved")
- **Impact:** Confusion between code and UI labels
- **Recommendation:** Standardize on one naming convention

### 5.3. Performance

- **Problem:** Large components (350-400 lines) with complex state management
- **Impact:** Harder to maintain and debug
- **Recommendation:** Split into smaller, focused components

### 5.4. Accessibility

- **Problem:** Some interactive elements lack proper ARIA labels
- **Impact:** Reduced accessibility for screen readers
- **Recommendation:** Add comprehensive ARIA attributes

---

## 6. Design System Gaps

### 6.1. Missing Dojo Genesis Elements

- ❌ No use of `Card` component from Wave 1
- ❌ No use of `Button` component from Wave 1
- ❌ No use of `StatusDot` component from Wave 1
- ❌ Custom color gradients instead of design system colors
- ❌ Inconsistent spacing (not using design system scale)
- ❌ Custom font sizes instead of design system typography

### 6.2. Animation Inconsistencies

- ✅ Uses Framer Motion (good)
- ❌ Animation timings don't match design system (100ms/200ms/300ms/500ms)
- ❌ Hover states use custom scales instead of design system

---

## 7. Recommendations for Merged Spec

### 7.1. Preserve (Do Not Regress)

1. **All semantic search functionality**
2. **Proactive suggestions system**
3. **Prompt critique scoring**
4. **Status lifecycle management**
5. **Public/private sharing**
6. **Optimistic UI updates**
7. **Error boundaries and loading states**
8. **Recent searches**
9. **Bulk actions**
10. **Multi-page architecture** (`/librarian`, `/greenhouse`, `/commons`)

### 7.2. Refactor (Apply Design System)

1. **Replace all color gradients** with Dojo Genesis palette
2. **Use Wave 1 base components** (`Card`, `Button`, `StatusDot`)
3. **Apply consistent spacing** from design system
4. **Use design system typography** (Inter font, standard sizes)
5. **Standardize animation timings**
6. **Add agent visual identities** (Librarian icon/color)

### 7.3. Fix (Known Bugs)

1. **Improve accessibility** (ARIA labels, keyboard navigation)
2. **Split large components** into smaller, focused pieces
3. **Standardize naming** (Seedling vs Active, Greenhouse vs Saved)
4. **Add loading skeletons** for all async operations

### 7.4. Enhance (New Features from v0.4.1 Spec)

1. **Add similarity score badges** to search results (already exists!)
2. **Add tag system** (partially exists, needs UI)
3. **Add fork count display** (already exists!)
4. **Improve responsive grid** (already responsive!)

---

## 8. Conclusion

The existing Librarian implementation is **significantly more advanced** than the v0.4.1 spec. The primary issue is **style/presentation**, not functionality.

**Strategy:**
- Create a **merged tech spec** that preserves all existing features
- Focus on **visual refactoring** to apply Dojo Genesis design system
- Fix known bugs and accessibility issues
- Avoid any functional regressions

**Estimated Effort:**
- **High:** Visual refactoring (all components need design system updates)
- **Medium:** Bug fixes and accessibility improvements
- **Low:** New features (most already exist)
